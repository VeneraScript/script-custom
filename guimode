local ESP = loadstring(game:HttpGet("https://raw.githubusercontent.com/VeneraScript/venera-esp/main/myEspScript.lua"))()
ESP:Toggle(true)

-- Performance Settings
local UPDATE_INTERVAL = 0.3 -- Seconds between updates
local MAX_DISTANCE = 500 -- Studs
local lastUpdate = 0

-- Basic ESP Settings
ESP.Players = false
ESP.Boxes = false
ESP.Names = true
ESP.TeamColor = false
ESP.FaceCamera = true
ESP.Distance = true
ESP.UseDisplayNames = false
ESP.ShowNPCs = false
ESP.ShowItems = false

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Item configuration
local itemTargets = {
    ["chair"] = Color3.fromRGB(139, 69, 19),
    ["book"] = Color3.fromRGB(210, 180, 140),
    ["newspaper"] = Color3.fromRGB(255, 255, 0),
    ["barrel"] = Color3.fromRGB(128, 128, 128),
    ["coal"] = Color3.fromRGB(0, 0, 0),
    ["snake oil"] = Color3.fromRGB(255, 0, 0),
    ["bandage"] = Color3.fromRGB(255, 255, 255),
    ["crucifix"] = Color3.fromRGB(255, 215, 0),
    ["gold"] = Color3.fromRGB(255, 215, 0),
    ["silver"] = Color3.fromRGB(192, 192, 192),
    ["brain in jar"] = Color3.fromRGB(0, 255, 0),
    ["bonds"] = Color3.fromRGB(0, 0, 255),
    ["revolver"] = Color3.fromRGB(255, 0, 0),
    ["shotgun"] = Color3.fromRGB(255, 69, 0),
    ["rifle"] = Color3.fromRGB(255, 140, 0),
    ["tomahawk"] = Color3.fromRGB(139, 69, 19),
    ["vampire knife"] = Color3.fromRGB(128, 0, 128),
    ["revolver ammo"] = Color3.fromRGB(255, 100, 100),
    ["shotgun shells"] = Color3.fromRGB(255, 150, 50),
    ["rifle ammo"] = Color3.fromRGB(255, 200, 0),
    ["jade sword"] = Color3.fromRGB(0, 128, 0),
    ["strange mask"] = Color3.fromRGB(75, 0, 130)
}

-- Creature configuration
local creatureTargets = {
    ["unicorn"] = Color3.fromRGB(255, 182, 193),
    ["outlaw"] = Color3.fromRGB(255, 0, 0),
    ["wolf"] = Color3.fromRGB(160, 160, 160),
    ["werewolf"] = Color3.fromRGB(100, 100, 100),
    ["vampire"] = Color3.fromRGB(128, 0, 128),
    ["model_walker"] = {color = Color3.fromRGB(0, 255, 0), name = "Zombie"},
    ["model_runner"] = {color = Color3.fromRGB(255, 165, 0), name = "Runner Zombie"}
}

local trackedItems = {}
local trackedCreatures = {}

-- Improved item validation with sack support
function IsValidItem(instance)
    if not instance or not instance.Parent then return false end
    
    -- Skip environment parts
    local nameLower = instance.Name:lower()
    if nameLower:find("wall") or nameLower:find("floor") or nameLower:find("building") then
        return false
    end
    
    -- Handle both Models and BaseParts
    if instance:IsA("Model") then
        return instance:FindFirstChild("Handle") or instance.PrimaryPart
    elseif instance:IsA("BasePart") then
        return true
    end
    
    return false
end

-- Optimized item ESP with sack tracking
function AddItemESP(item)
    if not item or not item.Parent then
        if trackedItems[item] then
            trackedItems[item]:Remove()
            trackedItems[item] = nil
        end
        return
    end

    if trackedItems[item] then return end

    local isValid, part = IsValidItem(item)
    if not isValid then return end

    part = part or (item:IsA("Model") and (item.PrimaryPart or item:FindFirstChild("Handle"))) or item
    if not part then return end

    -- Distance check
    local character = LocalPlayer.Character
    local hrp = character and character:FindFirstChild("HumanoidRootPart")
    if hrp and (part.Position - hrp.Position).Magnitude > MAX_DISTANCE then return end

    local nameLower = item.Name:lower()
    for itemName, color in pairs(itemTargets) do
        if nameLower:find(itemName:lower()) then
            local espObj = ESP:Add(item, {
                Name = itemName:gsub("^%l", string.upper),
                PrimaryPart = part,
                Color = color,
                IsEnabled = "ShowItems"
            })
            trackedItems[item] = espObj
            espObj.Enabled = ESP.ShowItems
            
            -- Special handling for sack system
            if item:FindFirstChild("Sack") then
                item:GetPropertyChangedSignal("Parent"):Connect(function()
                    if not item.Parent then
                        espObj.Enabled = false
                    else
                        espObj.Enabled = ESP.ShowItems
                    end
                end)
            end
            break
        end
    end
end

-- Creature detection (unchanged)
function AddCreatureESP(model)
    if trackedCreatures[model] then return end
    if model:IsA("Model") and model:FindFirstChildWhichIsA("Humanoid") then
        local hrp = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChildWhichIsA("BasePart")
        local myHrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not hrp or not myHrp or (hrp.Position - myHrp.Position).Magnitude > MAX_DISTANCE then return end

        local nameLower = model.Name:lower()
        for keyword, data in pairs(creatureTargets) do
            if nameLower:find(keyword) then
                local displayName = type(data) == "table" and data.name or keyword:gsub("^%l", string.upper)
                local color = type(data) == "table" and data.color or data
                
                local espObj = ESP:Add(model, {
                    Name = displayName,
                    PrimaryPart = hrp,
                    Color = color,
                    IsEnabled = "ShowNPCs"
                })
                trackedCreatures[model] = espObj
                break
            end
        end
    end
end

-- Optimized scanning with sack support
local function ScanWorkspace()
    for _, obj in ipairs(workspace:GetDescendants()) do
        AddCreatureESP(obj)
        AddItemESP(obj)
    end
end

-- Improved descendant tracking
local descendantAddedConn = workspace.DescendantAdded:Connect(function(obj)
    task.wait(0.3) -- Slightly longer delay for sack items
    AddCreatureESP(obj)
    AddItemESP(obj)
end)

-- Periodic cleanup
local RunService = game:GetService("RunService")
RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastUpdate < UPDATE_INTERVAL then return end
    lastUpdate = now
    
    -- Cleanup invalid items
    for item, espObj in pairs(trackedItems) do
        if not item or not item.Parent then
            espObj:Remove()
            trackedItems[item] = nil
        end
    end
    
    -- Cleanup invalid creatures
    for creature, espObj in pairs(trackedCreatures) do
        if not creature or not creature.Parent then
            espObj:Remove()
            trackedCreatures[creature] = nil
        end
    end
end)

-- Initial scan
task.spawn(ScanWorkspace)

-- [GUI CODE REMAINS THE SAME AS YOUR ORIGINAL]
-- ... (Rest of your existing UI code)

-- Auto-rescan when items toggle is enabled
createToggle("Items", 80, "ShowItems", function(val)
    for item, espObj in pairs(trackedItems) do
        espObj.Enabled = val
    end
    if val then
        task.spawn(function()
            ScanWorkspace() -- Full rescan when enabled
        end)
    end
end)
